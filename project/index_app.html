<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
	<title>WebNES</title>
    <meta charset="utf-8"/>
	<meta http-equiv="Cache-Control" content="no-store" /> <!-- stops chrome from caching -->
	
	<!-- build:css css/thirdparty.min.css -->	
	<link rel="stylesheet" href="../bower_components/jquery-ui/themes/smoothness/jquery-ui.css">
	<link rel="stylesheet" href="../bower_components/bower-qtip2/jquery.qtip.min.css">
	<!-- endbuild -->
	
	<!-- build:css css/main.min.css -->	
	<link rel="stylesheet" href="css/main.css">
	<!-- endbuild -->

</head>

<!-- onunload="" prevents firefox caching javascript files -->
<body onunload="" id="body">
<div id="fb-root"></div>
	<!-- facebook api -->
	<script>(function(d, s, id) {
	  var js, fjs = d.getElementsByTagName(s)[0];
	  if (d.getElementById(id)) return;
	  js = d.createElement(s); js.id = id;
	  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.0&appId=310800822454793";
	  fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));</script>
	
	<div id="content" class="normal" style="width:100%; height:100%; display:inline-block">
		<div id="infoPanel" class="infoPanel">
			<h1>WebNES</h1>
			<p>Drag a ROM file (can be zipped) onto the screen to load a game.</p>
			<p>Keys:</p>
			<ul>
			<li>Z - A button</li>
			<li>X - B button</li>
			<li>C - Select button</li>
			<li>V - Start button</li>
			<li>Arrow keys - DPAD</li>
			</ul>
			<p>Pete Ward, 2014 [peteward44 at gmail dot com]</p>
		</div>
		<div id="socialMediaPanel" class="socialMediaPanel">
			<div id="twitter">
				<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://peteward44.github.io/WebNES/" data-text="WebNES - A superior NES emulator for the Web">Tweet</a>
				<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
			</div>
			<div>&nbsp;</div>
			<div id="facebook">
				<div class="fb-like" data-href="http://peteward44.github.io/WebNES" data-layout="button" data-action="recommend" data-show-faces="true" data-share="true"></div>
			</div>
			<div>&nbsp;</div>
			<div id="google">
				<!-- Place this tag where you want the +1 button to render. -->
				<div class="g-plusone" data-size="medium" data-href="https://github.com/peteward44/WebNES"></div>

				<!-- Place this tag after the last +1 button tag. -->
				<script type="text/javascript">
				  window.___gcfg = {lang: 'en-GB'};

				  (function() {
					var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
					po.src = 'https://apis.google.com/js/platform.js';
					var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
				  })();
				</script>
			</div>
		</div>
		<div id="canvasWrapper" class="wrapper">
		</div>
		<div id="controlBar" class="controlBar">
			<div id="debugBar" class="ui-widget-header ui-corner-all">
				<button class="controlBarButton" id="debugControlBar_playOneFrameButton"></button>
				<div class="controlBarSeperator"></div>
				<button class="controlBarButton" id="debugControlBar_gameSpeedButton"></button>
				<!--<button class="controlBarButton" id="debugControlBar_getFrameHashButton"></button>-->
				<div class="controlBarSeperator"></div>
				<span id="debugControlBar_encoding">
					<input type="radio" id="debugControlBar_encodingNTSC" name="debugControlBar_encoding" value="NTSC"><label for="debugControlBar_encodingNTSC">NTSC</label>
					<input type="radio" id="debugControlBar_encodingPAL" name="debugControlBar_encoding" value="PAL"><label for="debugControlBar_encodingPAL">PAL</label>
				</span>
				<div class="controlBarSeperator"></div>
				<button class="controlBarButton" id="debugControlBar_selectTraceButton"></button>
				<ul id="debugControlBar_traceMenu">
					<li class="controlBarMenuButton" id="controlBar_cpuTraceParent"><input type="checkbox" id="controlBar_cpuTraceButton"><label for="controlBar_cpuTraceButton">CPU</label></li>
					<li class="controlBarMenuButton" id="controlBar_cpuInstructionsTraceParent"><input type="checkbox" id="controlBar_cpuInstructionsTraceButton"><label for="controlBar_cpuInstructionsTraceButton">CPU Instructions</label></li>
					<li class="controlBarMenuButton" id="controlBar_ppuTraceParent"><input type="checkbox" id="controlBar_ppuTraceButton"><label for="controlBar_ppuTraceButton">PPU</label></li>
					<li class="controlBarMenuButton" id="controlBar_mapperTraceParent"><input type="checkbox" id="controlBar_mapperTraceButton"><label for="controlBar_mapperTraceButton">Mapper</label></li>
					<li class="controlBarMenuButton" id="controlBar_allTraceParent"><input type="checkbox" id="controlBar_allTraceButton"><label for="controlBar_allTraceButton">All</label></li>
				</ul>
				<button class="controlBarButton" id="debugControlBar_traceButton"></button>
			</div>
			<div id="normalBar" class="ui-widget-header ui-corner-all">
				<button class="controlBarButton" id="controlBar_loadRomButton"></button>
				<div class="controlBarSeperator"></div>
				<button class="controlBarButton" id="controlBar_resetButton"></button>
				<div class="controlBarSeperator"></div>
				<button class="controlBarButton" id="controlBar_playButton"></button>
				<div class="controlBarSeperator"></div>
				<button class="controlBarButton" id="controlBar_soundButton"></button>
				<button class="controlBarButton" id="controlBar_screenshotButton"></button>
				<div class="controlBarSeperator"></div>
				<button class="controlBarButton" id="controlBar_quickSaveButton"></button>
				<button class="controlBarButton" id="controlBar_quickLoadButton"></button>
				<div class="controlBarSeperator"></div>
				<input class="controlBarButton" type="checkbox" id="controlBar_debugButton"><label for="controlBar_debugButton"></label>
				<div class="controlBarSeperator"></div>
				<button class="controlBarButton" id="controlBar_gameGenieButton"></button>
				<button class="controlBarButton" id="controlBar_errorDisplay"></button>
			</div>
		</div>
		<div id="controlBar_volumeSlider"></div>
		<div id="controlBar_alertMessage"></div>
		<div id="debugControlBar_gameSpeedSlider"></div>
		<div id="loadStateDialog">
			<div id="loadStateDialog_contents"></div>
		</div>
		<div id="debugWindow" class="debugWindow">
<!-- 			<div class="cpuInstructions">
			</div>
			<div class="logWindow">
			</div>
			<div class="paletteDisplay">
			</div>
			<div class="spriteDisplay">
			</div> -->
		</div>
		<div id="gameGenieDialog" class="gameGenieDialog">
			<div id="gameGenieDialog_contents"></div>
		</div>
	</div>
	
	<!-- shaders required by WebGL -->
	<script id="shader-fs" type="x-shader/x-fragment">
 		precision mediump float;
	//	varying vec2 vTextureCoord;
	//	uniform sampler2D uSampler;
	//	void main(void) {
	//		gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
	//	}
        uniform sampler2D rubyTexture;
        uniform vec2 rubyInputSize;
    //    uniform vec2 rubyOutputSize;
        uniform vec2 rubyTextureSize;

        varying vec2 texCoord;
        varying vec2 one;
        varying float mod_factor;

        // Comment the next line to disable interpolation in linear gamma (and gain speed).
        #define LINEAR_PROCESSING

        // Compensate for 16-235 level range as per Rec. 601.
        #define REF_LEVELS

        // Enable screen curvature.
        #define CURVATURE

        // Controls the intensity of the barrel distortion used to emulate the
        // curvature of a CRT. 0.0 is perfectly flat, 1.0 is annoyingly
        // distorted, higher values are increasingly ridiculous.
        #define distortion 0.2

        // Simulate a CRT gamma of 2.4.
        #define inputGamma  2.4

        // Compensate for the standard sRGB gamma of 2.2.
        #define outputGamma 2.2

        // Macros.
        #define FIX(c) max(abs(c), 1e-5);
        #define PI 3.141592653589

        #ifdef REF_LEVELS
        #       define LEVELS(c) max((c - 16.0 / 255.0) * 255.0 / (235.0 - 16.0), 0.0)
        #else
        #       define LEVELS(c) c
        #endif

        #ifdef LINEAR_PROCESSING
        #       define TEX2D(c) pow(LEVELS(texture2D(rubyTexture, (c))), vec4(inputGamma))
        #else
        #       define TEX2D(c) LEVELS(texture2D(rubyTexture, (c)))
        #endif

        // Apply radial distortion to the given coordinate.
        vec2 radialDistortion(vec2 coord)
        {
                coord *= rubyTextureSize / rubyInputSize;
                vec2 cc = coord - 0.5;
                float dist = dot(cc, cc) * distortion;
                return (coord + cc * (1.0 + dist) * dist) * rubyInputSize / rubyTextureSize;
        }

        // Calculate the influence of a scanline on the current pixel.
        //
        // 'distance' is the distance in texture coordinates from the current
        // pixel to the scanline in question.
        // 'color' is the colour of the scanline at the horizontal location of
        // the current pixel.
        vec4 scanlineWeights(float distance, vec4 color)
        {
                // The "width" of the scanline beam is set as 2*(1 + x^4) for
                // each RGB channel.
                vec4 wid = 2.0 + 2.0 * pow(color, vec4(4.0));

                // The "weights" lines basically specify the formula that gives
                // you the profile of the beam, i.e. the intensity as
                // a function of distance from the vertical center of the
                // scanline. In this case, it is gaussian if width=2, and
                // becomes nongaussian for larger widths. Ideally this should
                // be normalized so that the integral across the beam is
                // independent of its width. That is, for a narrower beam
                // "weights" should have a higher peak at the center of the
                // scanline than for a wider beam.
                vec4 weights = vec4(distance / 0.3);
                return 1.4 * exp(-pow(weights * inversesqrt(0.5 * wid), wid)) / (0.6 + 0.2 * wid);
        }

        void main()
        {
                // Here's a helpful diagram to keep in mind while trying to
                // understand the code:
                //
                //  |      |      |      |      |
                // -------------------------------
                //  |      |      |      |      |
                //  |  01  |  11  |  21  |  31  | <-- current scanline
                //  |      | @    |      |      |
                // -------------------------------
                //  |      |      |      |      |
                //  |  02  |  12  |  22  |  32  | <-- next scanline
                //  |      |      |      |      |
                // -------------------------------
                //  |      |      |      |      |
                //
                // Each character-cell represents a pixel on the output
                // surface, "@" represents the current pixel (always somewhere
                // in the bottom half of the current scan-line, or the top-half
                // of the next scanline). The grid of lines represents the
                // edges of the texels of the underlying texture.

                // Texture coordinates of the texel containing the active pixel.
        #ifdef CURVATURE
                vec2 xy = radialDistortion(texCoord);
        #else
                vec2 xy = texCoord;
        #endif

                // Of all the pixels that are mapped onto the texel we are
                // currently rendering, which pixel are we currently rendering?
                vec2 ratio_scale = xy * rubyTextureSize - vec2(0.5);
                vec2 uv_ratio = fract(ratio_scale);

                // Snap to the center of the underlying texel.
                xy = (floor(ratio_scale) + vec2(0.5)) / rubyTextureSize;

                // Calculate Lanczos scaling coefficients describing the effect
                // of various neighbour texels in a scanline on the current
                // pixel.
                vec4 coeffs = PI * vec4(1.0 + uv_ratio.x, uv_ratio.x, 1.0 - uv_ratio.x, 2.0 - uv_ratio.x);

                // Prevent division by zero.
                coeffs = FIX(coeffs);

                // Lanczos2 kernel.
                coeffs = 2.0 * sin(coeffs) * sin(coeffs / 2.0) / (coeffs * coeffs);

                // Normalize.
                coeffs /= dot(coeffs, vec4(1.0));

                // Calculate the effective colour of the current and next
                // scanlines at the horizontal location of the current pixel,
                // using the Lanczos coefficients above.
                vec4 col  = clamp(mat4(
                        TEX2D(xy + vec2(-one.x, 0.0)),
                        TEX2D(xy),
                        TEX2D(xy + vec2(one.x, 0.0)),
                        TEX2D(xy + vec2(2.0 * one.x, 0.0))) * coeffs,
                        0.0, 1.0);
                vec4 col2 = clamp(mat4(
                        TEX2D(xy + vec2(-one.x, one.y)),
                        TEX2D(xy + vec2(0.0, one.y)),
                        TEX2D(xy + one),
                        TEX2D(xy + vec2(2.0 * one.x, one.y))) * coeffs,
                        0.0, 1.0);

        #ifndef LINEAR_PROCESSING
                col  = pow(col , vec4(inputGamma));
                col2 = pow(col2, vec4(inputGamma));
        #endif

                // Calculate the influence of the current and next scanlines on
                // the current pixel.
                vec4 weights  = scanlineWeights(uv_ratio.y, col);
                vec4 weights2 = scanlineWeights(1.0 - uv_ratio.y, col2);
                vec3 mul_res  = (col * weights + col2 * weights2).rgb;

                // dot-mask emulation:
                // Output pixels are alternately tinted green and magenta.
                vec3 dotMaskWeights = mix(
                        vec3(1.0, 0.7, 1.0),
                        vec3(0.7, 1.0, 0.7),
                        floor(mod(mod_factor, 2.0))
                    );

                mul_res *= dotMaskWeights;

                // Convert the image gamma for display on our output device.
                mul_res = pow(mul_res, vec3(1.0 / outputGamma));

                // Color the texel.
                gl_FragColor = vec4(mul_res, 1.0);
        }
	</script>

	<script id="shader-vs" type="x-shader/x-vertex">
		precision mediump float;
		
		attribute vec3 aVertexPosition;
		uniform mat4 aModelViewProjectionMatrix;
		attribute vec2 aTextureCoord;
	//	uniform mat4 uMVMatrix;
	//	uniform mat4 uPMatrix;
	//	varying vec2 vTextureCoord;
	//	void main(void) {
	//		gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
	//		vTextureCoord = aTextureCoord;
	//	}
        uniform vec2 rubyInputSize;
        uniform vec2 rubyOutputSize;
        uniform vec2 rubyTextureSize;

        // Define some calculations that will be used in fragment shader.
        varying vec2 texCoord;
        varying vec2 one;
        varying float mod_factor;

        void main()
        {
                // Do the standard vertex processing.
                gl_Position = aModelViewProjectionMatrix * vec4(aVertexPosition, 1.0);

                // Precalculate a bunch of useful values we'll need in the fragment
                // shader.

                // Texture coords.
                texCoord = aTextureCoord.xy;

                // The size of one texel, in texture-coordinates.
                one = 1.0 / rubyTextureSize;

                // Resulting X pixel-coordinate of the pixel we're drawing.
                mod_factor = texCoord.x * rubyTextureSize.x * rubyOutputSize.x / rubyInputSize.x;
        }
	</script>

	<!-- build:js js/nes.components.min.js -->
	<script type="text/javascript" src="js/polyfills/arrayPolyfills.js"></script>
	<script type="text/javascript" src="js/polyfills/typedarrays.js"></script>
	<script type="text/javascript" src="js/polyfills/setImmediatePolyfill.js"></script>
	<script type="text/javascript" src="js/utils/typedArrayBoundsCheck.js"></script>
	
	<script type="text/javascript" src="../bower_components/gl-matrix/dist/gl-matrix-min.js"></script>
	<script type="text/javascript" src="../bower_components/canvas-toBlob.js/canvas-toBlob.js"></script>
	<script type="text/javascript" src="../bower_components/jquery/dist/jquery.min.js"></script>
	<script type="text/javascript" src="../bower_components/jquery-ui/jquery-ui.min.js"></script>
	<script type="text/javascript" src="../bower_components/bower-qtip2/jquery.qtip.min.js"></script>
	<script type="text/javascript" src="../bower_components/jsziptools/jsziptools.js"></script>
	<script type="text/javascript" src="../bower_components/jszip/jszip.min.js"></script>
	<script type="text/javascript" src="../bower_components/FileSaver/FileSaver.js"></script>
	<script type="text/javascript" src="../bower_components/rusha/rusha.min.js"></script>
	<script type="text/javascript" src="../bower_components/fpsmeter/dist/fpsmeter.min.js"></script>
	<!-- endbuild -->
		
	<!-- build:js js/nes.min.js -->	
	<script type="text/javascript" src="js/polyfills/fastSetImmediate.js"></script>
	<script type="text/javascript" src="js/gui/logWindow.js"></script>
	
	<script type="text/javascript" src="js/utils/event.js"></script>
	<script type="text/javascript" src="js/utils/romLoader.js"></script>
	<script type="text/javascript" src="js/utils/decompress7z.js"></script>
	<script type="text/javascript" src="js/utils/serialisation.js"></script>

	<script type="text/javascript" src="js/interface/webGlUtils.js"></script>
	<script type="text/javascript" src="js/interface/canvasRenderSurface.js"></script>
	<script type="text/javascript" src="js/interface/webGlRenderSurface.js"></script>
	<script type="text/javascript" src="js/interface/dragDrop.js"></script>
	<script type="text/javascript" src="js/interface/input.js"></script>
	<script type="text/javascript" src="js/interface/saveLoadState.js"></script>
	<script type="text/javascript" src="js/interface/trace.js"></script>
	<script type="text/javascript" src="js/interface/webAudioRenderer.js"></script>
	
	<script type="text/javascript" src="js/gui/canvasParent.js"></script>
	<script type="text/javascript" src="js/gui/controlBarElements.js"></script>
	<script type="text/javascript" src="js/gui/controlBar.js"></script>
	<script type="text/javascript" src="js/gui/loadStateDialog.js"></script>
	<script type="text/javascript" src="js/gui/gameGenieDialog.js"></script>
	<script type="text/javascript" src="js/gui/spriteDisplayWindow.js"></script>
	<script type="text/javascript" src="js/gui/paletteDisplayWindow.js"></script>
	<script type="text/javascript" src="js/gui/cpuInstructionsWindow.js"></script>
	
	<script type="text/javascript" src="js/nes/consts.js"></script>
	<script type="text/javascript" src="js/nes/synchroniser.js"></script>
	<script type="text/javascript" src="js/nes/controller.js"></script>
	<script type="text/javascript" src="js/nes/memory.js"></script>
	<script type="text/javascript" src="js/nes/cpu6502_instructions_fast.js"></script>
	<script type="text/javascript" src="js/nes/cpu6502_instructions_fast_switch.js"></script>
	<script type="text/javascript" src="js/nes/cpu6502_instructions_trace.js"></script>
	<script type="text/javascript" src="js/nes/cpu6502_instructions_formatString.js"></script>
	<script type="text/javascript" src="js/nes/cpu6502.js"></script>
	
	<!-- Blargg apu port -->
	<script type="text/javascript" src="js/nes/apulib/Wave_Writer.js"></script>
	<script type="text/javascript" src="js/nes/apulib/Blip_Buffer.js"></script>
	<script type="text/javascript" src="js/nes/apulib/Blip_Synth.js"></script>
	<script type="text/javascript" src="js/nes/apulib/Nes_Oscs.js"></script>
	<script type="text/javascript" src="js/nes/apulib/Nes_Apu.js"></script>	
	<script type="text/javascript" src="js/nes/apu_legacy.js"></script>
	
	<!-- new apu -->
	<script type="text/javascript" src="js/nes/apu/frameCounter.js"></script>
	<script type="text/javascript" src="js/nes/apu/outputBuffer.js"></script>
	<script type="text/javascript" src="js/nes/apu/envelope.js"></script>
	<script type="text/javascript" src="js/nes/apu/squareWave.js"></script>
	<script type="text/javascript" src="js/nes/apu.js"></script>

	<script type="text/javascript" src="js/test/squareWaveTester.js"></script>
	
	<script type="text/javascript" src="js/nes/ppu_renderBg.js"></script>
	<script type="text/javascript" src="js/nes/ppu_renderSprites.js"></script>
	<script type="text/javascript" src="js/nes/ppu.js"></script>
	
	<script type="text/javascript" src="js/nes/mappers/basemapper.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper0.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper1.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper2.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper3.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper4.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper5.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper6.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper7.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper8.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper9.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper11.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper13.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper15.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper17.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper34.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper41.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper64.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper65.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper66.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper71.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper78.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper79.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper180.js"></script>
	<script type="text/javascript" src="js/nes/mappers/mapper206.js"></script>
	
	<script type="text/javascript" src="js/nes/dbLookup.js"></script>
	<script type="text/javascript" src="js/nes/gameGenie.js"></script>
		
	<script type="text/javascript" src="js/nes/cartridge.js"></script>
	<script type="text/javascript" src="js/nes/renderbuffer.js"></script>
	<script type="text/javascript" src="js/nes/mainboard.js"></script>

	<script type="text/javascript" src="js/app.js"></script>
	<script type="text/javascript" src="js/saveStateManager.js"></script>
	<script type="text/javascript" src="js/browserStart.js"></script>
	<!-- endbuild -->
</body>
</html>
